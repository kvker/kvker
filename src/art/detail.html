<!DOCTYPE html>
<html lang="zh">

<head>
  <title>kvker的个人网站</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="utf-8">
  <meta name="description" content="kvker个人的聚合搜索网站, 搜罗多多的网站">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel='stylesheet' href='/css/custom.css' />
  <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/default.min.css">

  <style>
    main {
      padding: 20px;
    }

    pre {
      width: 100%;
      margin-top: 20px;
    }

    @media (prefers-color-scheme: dark) {

      #delete_btn,
      #edit_btn {
        color: #fff;
      }
    }
  </style>

</head>

<body>

  <nav class="flex jcsb top-nav">
    <div class="nav-side"></div>
    <div class="flex jcc aic">
      <a class="nav-item" href="/">首页</a>
      <a class="nav-item" href="/tool.html">工具</a>
    </div>
    <div id="account" class="nav-side">账号</div>
  </nav>

  <main class="flex-column aic">
    <h1 id="title"></h1>
    <pre id="markdown"></pre>
    <div id="ctrls_box" style="display: none;">
      <button id="edit_btn" style="padding: 4px 8px;">编辑</button>
      <button id="delete_btn" style="padding: 4px 8px;">删除</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.2.0/dist/av-min.js"></script>
  <script src="/js/av.js"></script>
  <script src="/js/kk.js"></script>
  <script src="/js/base.js"></script>
  <script src="https://cdn.staticfile.org/marked/1.20/marked.min.js"></script>
  <script src="https://cdn.staticfile.org/highlight.js/10.1.2/highlight.min.js"></script>

  <script>
    let renderer_MD = new marked.Renderer()
    marked.setOptions({
      renderer: renderer_MD,
      gfm: true,
      tables: true,
      breaks: false,
      pedantic: false,
      sanitize: false,
      smartLists: true,
      smartypants: false
    })

    const app = new class extends Base {
      constructor() {
        super()
        this.id = this.query_params.id
        this.queryID('edit_btn').addEventListener('click', _ => location.href = `edit.html?id=${this.id}`)
        this.queryID('delete_btn').addEventListener('click', this.clickDelete.bind(this))
        if(this.userinfo) {
          this.el.ctrls_box.style.display = 'block'
        }
        av.read('Note', q => {
          q.equalTo('objectId', this.id)
        }).then(ret => {
          let item = ret[0]
          let markdown_string = item.get('content')
          marked.setOptions({
            highlight(code) {
              return hljs.highlightAuto(code).value
            }
          })

          this.update({
            title: item.get('title'),
            markdown: {
              html: marked(markdown_string)
            }
          })
        }).catch(error => {
          console.error(error)
          alert(error.message)
        })
      }

      listenLogin() {
        this.el.ctrls_box.style.display = 'block'
      }

      listenLogout() {
        this.el.ctrls_box.style.display = 'none'
      }

      clickDelete() {
        if(confirm('确定删除吗?') && this.user) {
          av.delete('Note', this.id).then(ret => {
            alert('删除成功')
            location.replace('/art.html')
          })
        }
      }
    }
  </script>
</body>

</html>